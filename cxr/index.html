<head>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161484045-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161484045-1');
</script>


<link rel="stylesheet" href="site.css" />

<!-- Load TensorFlow.js. This is required to use MobileNet. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.1"> </script>

<!-- thirdparty -->
<script src="thirdparty/dropzone.min.js"> </script>
<link rel="stylesheet" href="thirdparty/dropzone.min.css"/>

</head>

<body>

<div id="page">

<h1>Pneumonia severity prediction prototype</h1>
<p>Not validated for any purpose</p>

<img id="cxrImage" src="skeleton.svg" width=50 width=50></img>

<h2 id="cxrStatus">Downloading predictive model...</h2>

<form action="/file-upload"
      class="dropzone"
      id="cxrDropzone">
  <p class="dz-message">Drop chest X ray image here, or click to upload</p>
</form>

<script>

  const pneumoniaPredictions = [ "Atelectasis", "Cardiomegaly", "Consolidation", "Edema",
    "Effusion", "Emphysema", "Fibrosis", "Hernia", "Infiltration", "Mass", "Nodule",
    "Pleural Thickening", "Pneumonia", "Pneumothora"]

  const modelURL = 'https://storage.googleapis.com/cxr-models/CheXNet_acil-tfjs/model.json';
  const modelLoadPromise = tf.loadLayersModel(modelURL);

  const imageElement = document.getElementById('cxrImage');
  const imageLogoSource = imageElement.src;
  const dropzoneElement = document.getElementById('cxrDropzone');
  let model;
  let predicting = false;
  const filesToProcess = [];

  modelLoadPromise
  .then(loadedModel => {
    model = loadedModel;
    document.getElementById('cxrStatus').innerText = "Model is ready";
    triggerPrediction()
  });

  function triggerPrediction() {
    console.log('triggered for ', filesToProcess);
    if (predicting || filesToProcess.length == 0) {
      console.log('returning');
      return;
    }
    predicting = true;
    const file = filesToProcess.pop();
    console.log('predicting ', file.name);
    document.getElementById('cxrStatus').innerText = "Working...";
    dropzone.removeFile(file);
    imageElement.src = file.dataURL;
    imageElement.onload = function() {
      const tensor = tf.browser.fromPixels(imageElement);
      const reshapedTensor = tensor.reshape([1, imageElement.height, imageElement.width, 3]);
      predictionTensor = model.predict(reshapedTensor)
      predictionTensor.data()
      .then(data => {
        const header = document.createElement("h2");
        document.body.appendChild(header);
        header.innerText = `Predictions for ${file.name}`;
        const img = document.createElement("img");
        document.body.appendChild(img);
        img.src = file.dataURL;
        img.width = 200
        for (index = 0; index < data.length; index++) {
          const result = document.createElement("p");
          result.innerText = `${pneumoniaPredictions[index]}: ${data[index]}`
          document.body.appendChild(result);
        }
        predicting = false
        console.log('predict finished', file.name);
        document.getElementById('cxrStatus').innerText = "Finished...";
        triggerPrediction();
      });
    }
  }

</script>

<script>
// code that needs to execute after document body is loaded
(function() {
  Dropzone.autoDiscover = false;
  dropzone = new Dropzone(dropzoneElement, {
    autoProcessQueue: true,
  });
  dropzone.on("error", (file) => {
    console.log("error triggered", file);
    dropzone.getAcceptedFiles().forEach(file => {
      if (file.dataURL  && filesToProcess.indexOf(file) == -1) {
        filesToProcess.unshift(file);
      }
    });
    console.log('trigger predict', filesToProcess)
    triggerPrediction();
  });

})();
</script>

</body>
