<head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161484045-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161484045-1');
</script>


<link rel="stylesheet" href="site.css" />

<!-- Load TensorFlow.js. This is required to use MobileNet. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.0"> </script>

<!-- thirdparty -->
<script src="thirdparty/dropzone.min.js"> </script>
<link rel="stylesheet" href="thirdparty/dropzone.min.css"/>

</head>

<body>

<div id="page">

<h1>Chest X Ray QC (prototype)</h1>
<p>For informational use only. Not validated for any other purpose.</p>

<img id="cxrLogo" src="skeleton.svg" width=100 height=100></img>

<h2 id="cxrStatus"></h2>

<form action="/file-upload"
      class="dropzone"
      id="cxrDropzone">
  <p class="dz-message">Drop chest X ray image here, or click to upload</p>
</form>

<img id="cxrImage" hidden=true width=1024 height=1024></img>

<script>

  function status(message) {
    console.log(message);
    document.getElementById('cxrStatus').innerText = message;
  }

  //const modelName = "CheXNet_acil-tfjs";
  //const modelName = "modeltest-003-0.894167-0.769167.tfjs";
  const modelName = "modeltest-003-0.886000-0.806667.tfjs";
  const modelURL = `https://storage.googleapis.com/cxr-models/${modelName}/model.json`;

  status('Downloading predictive model');
  const modelLoadPromise = tf.loadLayersModel(modelURL, {
    onProgress: (fraction) => {status(`${(fraction * 100).toFixed(1)}% loaded...`);},
  });

  const imageElement = document.getElementById('cxrImage');
  const imageLogoSource = imageElement.src;
  const dropzoneElement = document.getElementById('cxrDropzone');
  let model;
  let predicting = false;
  const filesToProcess = [];
  const filesProcessed = [];

  function checkAcceptedFiles(file) {
    file = file || {name: "unspecified"};
    console.log("error triggered", file.name);
    dropzone.getAcceptedFiles().forEach(file => {
      console.log(`checking ${file.name}`);
      if (file.dataURL
            && filesToProcess.indexOf(file) == -1) {
        status(`adding ${file.name}`);
        filesToProcess.unshift(file);
      }
    });
    console.log('trigger predict', filesToProcess)
    triggerPrediction();
  }

  modelLoadPromise
  .then(loadedModel => {
    model = loadedModel;
    status("Model is ready");
    triggerPrediction()
  });

  function triggerPrediction() {
    console.log('triggered for ', filesToProcess);
    if (predicting || filesToProcess.length == 0) {
      if (!predicting) {
        //imageElement.src = "skeleton.svg";
      }
      console.log('triggered, but nothing to predict');
      console.log('predicting', predicting);
      console.log('filesToProcess', filesToProcess);
      return;
    }
    predicting = true;
    const file = filesToProcess.pop();
    status(`Predicting ${file.name}...`);
    setTimeout(() => {
      imageElement.src = file.dataURL;
      imageElement.onload = function() {
        dropzone.removeFile(file);
        const tensor = tf.browser.fromPixels(imageElement);
        const reshapedTensor = tensor.reshape([-1, imageElement.height, imageElement.width, 3]);
        predictionTensor = model.predict(reshapedTensor, {verbose: true})
        predictionTensor.data()
        .then(data => {
          const header = document.createElement("h2");
          document.body.appendChild(header);
          header.innerText = `Results for: ${file.name}`;
          const reportThumbndail = document.createElement("img");
          document.body.appendChild(reportThumbndail);
          reportThumbndail.src = file.dataURL;
          reportThumbndail.width = 200
          const result = document.createElement("p");
          if (data[1]) {
            result.innerText = `Result: Good chest X ray!`;
          } else {
            result.innerText = `Result: Bad chest X ray!`;
          }
          document.body.appendChild(result);
          predicting = false
          filesProcessed.unshift(file);
          status(`Finished predicting ${file.name}.`);
          checkAcceptedFiles();
        });
      }
    }, 5);
  }

</script>

<script>
// code that needs to execute after document body is loaded
(function() {
  Dropzone.autoDiscover = false;
  dropzone = new Dropzone(dropzoneElement, {
    autoProcessQueue: true,
    parallelUploads: 1,
  });
  dropzone.on("error", checkAcceptedFiles);

})();
</script>

</body>
